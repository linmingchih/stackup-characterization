<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stackup Characterization</title>
    <link rel="icon" href="data:,">
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            height: 100vh;
            background-color: #f0f2f5;
            color: #333;
        }

        /* Top Bar */
        .top-bar {
            background-color: #ffffff;
            padding: 15px 20px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            display: flex;
            align-items: center;
            gap: 15px;
            z-index: 10;
        }

        .control-group {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        input[type="text"],
        input[type="number"] {
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 14px;
        }

        button {
            padding: 8px 16px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        button:hover {
            background-color: #0056b3;
        }

        button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }

        /* Main Panel */
        .main-panel {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
        }

        .stats-table {
            width: 100%;
            border-collapse: collapse;
            background-color: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .stats-table th,
        .stats-table td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }

        .stats-table th {
            background-color: #f8f9fa;
            font-weight: 600;
            color: #555;
        }

        .status-badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }

        .status-pending {
            background-color: #e9ecef;
            color: #495057;
        }

        .status-running {
            background-color: #e3f2fd;
            color: #0d6efd;
        }

        .status-done {
            background-color: #d1e7dd;
            color: #0f5132;
        }

        .status-failed {
            background-color: #f8d7da;
            color: #842029;
        }

        .status-max-iter {
            background-color: #fff3cd;
            color: #664d03;
        }

        /* Bottom Panel */
        .bottom-panel {
            height: 200px;
            background-color: #212529;
            color: #f8f9fa;
            padding: 15px;
            overflow-y: auto;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 13px;
            border-top: 1px solid #444;
        }

        .log-entry {
            margin-bottom: 4px;
            word-wrap: break-word;
        }

        .log-timestamp {
            color: #888;
            margin-right: 8px;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 100;
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            width: 300px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
        }

        .form-group input {
            width: 100%;
            box-sizing: border-box;
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }

        .modal-actions {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 20px;
        }
    </style>
</head>

<body>

    <div class="top-bar">
        <div class="control-group">
            <input type="text" id="filePath" placeholder="Select JSON file..." readonly style="width: 300px;">
            <button onclick="selectFile()" title="Browse File">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                    <path
                        d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5z" />
                    <path
                        d="M7.646 1.146a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1-.708.708L8.5 2.707V11.5a.5.5 0 0 1-1 0V2.707L5.354 4.854a.5.5 0 1 1-.708-.708l3-3z" />
                </svg>
            </button>
        </div>
        <div class="control-group">
            <label for="maxIter">Max Iterations:</label>
            <input type="number" id="maxIter" value="10" min="1" style="width: 60px;">
        </div>
        <button id="startBtn" onclick="startOptimization()" title="Start Optimization">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                <path
                    d="M10.804 8 5 4.633v6.734L10.804 8zm.792-.696a.802.802 0 0 1 0 1.392l-6.363 3.692C4.713 12.69 4 12.345 4 11.692V4.308c0-.653.713-.998 1.233-.696l6.363 3.692z" />
            </svg>
        </button>
        <button onclick="openStackupEditor()" style="background-color: #28a745;" title="Stackup Editor">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                <path
                    d="M12.146.146a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1 0 .708l-10 10a.5.5 0 0 1-.168.11l-5 2a.5.5 0 0 1-.65-.65l2-5a.5.5 0 0 1 .11-.168l10-10zM11.207 2.5 13.5 4.793 14.793 3.5 12.5 1.207 11.207 2.5zm1.586 3L10.5 3.207 4 9.707V10h.5a.5.5 0 0 1 .5.5v.5h.5a.5.5 0 0 1 .5.5v.5h.293l6.5-6.5zm-9.761 5.175-.106.106-1.528 3.821 3.821-1.528.106-.106A.5.5 0 0 1 5 12.5V12h-.5a.5.5 0 0 1-.5-.5V11h-.5a.5.5 0 0 1-.468-.325z" />
            </svg>
        </button>
        <button onclick="openSettings()" style="margin-left: auto; background-color: #6c757d;" title="Settings">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                <path
                    d="M8 4.754a3.246 3.246 0 1 0 0 6.492 3.246 3.246 0 0 0 0-6.492zM5.754 8a2.246 2.246 0 1 1 4.492 0 2.246 2.246 0 0 1-4.492 0z" />
                <path
                    d="M9.796 1.343c-.527-1.79-3.065-1.79-3.592 0l-.094.319a.873.873 0 0 1-1.255.52l-.292-.16c-1.64-.892-3.433.902-2.54 2.541l.159.292a.873.873 0 0 1-.52 1.255l-.319.094c-1.79.527-1.79 3.065 0 3.592l.319.094a.873.873 0 0 1 .52 1.255l-.16.292c-.892 1.64.901 3.434 2.541 2.54l.292-.159a.873.873 0 0 1 1.255.52l.094.319c.527 1.79 3.065 1.79 3.592 0l.094-.319a.873.873 0 0 1 1.255-.52l.292.16c1.64.893 3.434-.902 2.54-2.541l-.159-.292a.873.873 0 0 1 .52-1.255l.319-.094c1.79-.527 1.79-3.065 0-3.592l-.319-.094a.873.873 0 0 1-.52-1.255l.16-.292c.893-1.64-.902-3.433-2.541-2.54l-.292.159a.873.873 0 0 1-1.255-.52l-.094-.319zm-2.633.283c.246-.835 1.428-.835 1.674 0l.094.319a1.873 1.873 0 0 0 2.693 1.115l.291-.16c.764-.415 1.6.42 1.184 1.185l-.159.292a1.873 1.873 0 0 0 1.116 2.692l.318.094c.835.246.835 1.428 0 1.674l-.319.094a1.873 1.873 0 0 0-1.115 2.693l.16.291c.415.764-.42 1.6-1.185 1.184l-.291-.159a1.873 1.873 0 0 0-2.693 1.116l-.094.318c-.246.835-1.428.835-1.674 0l-.094-.319a1.873 1.873 0 0 0-2.692-1.115l-.292.16c-.764.415-1.6-.42-1.184-1.185l.159-.291A1.873 1.873 0 0 0 1.945 8.93l-.319-.094c-.835-.246-.835-1.428 0-1.674l.319-.094A1.873 1.873 0 0 0 3.06 4.377l-.16-.292c-.415-.764.42-1.6 1.185-1.184l.292.159a1.873 1.873 0 0 0 2.692-1.115l.094-.319z" />
            </svg>
        </button>
    </div>

    <div class="main-panel">
        <table class="stats-table">
            <thead>
                <tr>
                    <th>Layer</th>
                    <th>Status</th>
                    <th>Iter</th>
                    <th>Target Z</th>
                    <th>Best Z</th>
                    <th>Target Loss</th>
                    <th>Best Loss</th>
                    <th>Time</th>
                </tr>
            </thead>
            <tbody id="statsBody">
                <!-- Rows will be added here dynamically -->
            </tbody>
        </table>
    </div>

    <div class="bottom-panel" id="logPanel">
        <div class="log-entry">Ready to start.</div>
    </div>

    <!-- Settings Modal -->
    <div id="settingsModal" class="modal">
        <div class="modal-content">
            <h2>Configuration</h2>
            <div class="form-group">
                <label>AEDT Version:</label>
                <input type="text" id="cfg_aedt_version" placeholder="e.g. 2025.2">
            </div>
            <div class="form-group">
                <label>EDB Version:</label>
                <input type="text" id="cfg_edb_version" placeholder="e.g. 2024.1">
            </div>
            <div class="modal-actions">
                <button onclick="saveSettings()">Save</button>
                <button onclick="closeSettings()" style="background-color: #6c757d;">Cancel</button>
            </div>
        </div>
    </div>

    <script>
        // API Wrapper
        async function selectFile() {
            const path = await pywebview.api.select_file();
            if (path) {
                document.getElementById('filePath').value = path;

                // Load info and initialize table
                const result = await pywebview.api.load_file_info(path);
                if (result.status === 'success') {
                    const tbody = document.getElementById('statsBody');
                    tbody.innerHTML = ''; // Clear existing

                    result.layers.forEach(layer => {
                        updateStats(layer.name, {
                            status: 'Pending',
                            iterations: 0,
                            target_z: layer.target_z,
                            target_loss: layer.target_loss,
                            best_z: 0,
                            best_loss: 0,
                            time_elapsed: '-'
                        });
                    });
                    addLog(`Loaded ${result.layers.length} signal layers from ${path}`);
                } else {
                    alert("Failed to load file info: " + result.message);
                    addLog("Error loading file: " + result.message);
                }
            }
        }

        async function startOptimization() {
            const path = document.getElementById('filePath').value;
            const maxIter = document.getElementById('maxIter').value;

            if (!path) {
                alert("Please select a file first.");
                return;
            }

            const btn = document.getElementById('startBtn');
            btn.disabled = true;
            btn.textContent = "Running...";

            // Clear table
            // document.getElementById('statsBody').innerHTML = ''; 
            document.getElementById('logPanel').innerHTML = '';
            addLog("Starting optimization...");

            const result = await pywebview.api.start_optimization(path, maxIter);
            if (result.status === 'error') {
                alert(result.message);
                btn.disabled = false;
                btn.textContent = "Start Optimization";
                addLog("Error: " + result.message);
            }
        }

        function addLog(msg) {
            const panel = document.getElementById('logPanel');
            const div = document.createElement('div');
            div.className = 'log-entry';
            const time = new Date().toLocaleTimeString();
            div.innerHTML = `<span class="log-timestamp">[${time}]</span> ${msg}`;
            panel.appendChild(div);
            panel.scrollTop = panel.scrollHeight;
        }

        function updateStats(layerName, stats) {
            // stats object: { status, iterations, target_z, best_z, target_loss, best_loss, time_elapsed }
            const tbody = document.getElementById('statsBody');
            let row = document.getElementById(`row-${layerName}`);

            if (!row) {
                row = document.createElement('tr');
                row.id = `row-${layerName}`;
                row.innerHTML = `
                    <td>${layerName}</td>
                    <td class="col-status"><span class="status-badge status-pending">Pending</span></td>
                    <td class="col-iter">-</td>
                    <td class="col-target-z">-</td>
                    <td class="col-best-z">-</td>
                    <td class="col-target-loss">-</td>
                    <td class="col-best-loss">-</td>
                    <td class="col-time">-</td>
                `;
                tbody.appendChild(row);
            }

            // Update columns
            const statusCell = row.querySelector('.col-status');
            let statusClass = 'status-pending';
            if (stats.status === 'Running') statusClass = 'status-running';
            else if (stats.status === 'Done') statusClass = 'status-done';
            else if (stats.status === 'Failed') statusClass = 'status-failed';
            else if (stats.status === 'Max Iter') statusClass = 'status-max-iter';

            statusCell.innerHTML = `<span class="status-badge ${statusClass}">${stats.status}</span>`;

            row.querySelector('.col-iter').textContent = stats.iterations;
            row.querySelector('.col-target-z').textContent = stats.target_z !== undefined ? stats.target_z.toFixed(2) : '-';
            row.querySelector('.col-best-z').textContent = stats.best_z !== undefined ? stats.best_z.toFixed(2) : '-';
            row.querySelector('.col-target-loss').textContent = stats.target_loss !== undefined ? stats.target_loss.toFixed(3) : '-';
            row.querySelector('.col-best-loss').textContent = stats.best_loss !== undefined ? stats.best_loss.toFixed(3) : '-';
            row.querySelector('.col-time').textContent = stats.time_elapsed || '-';
        }

        function optimizationComplete() {
            document.getElementById('startBtn').disabled = false;
            document.getElementById('startBtn').innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                <path d="M10.804 8 5 4.633v6.734L10.804 8zm.792-.696a.802.802 0 0 1 0 1.392l-6.363 3.692C4.713 12.69 4 12.345 4 11.692V4.308c0-.653.713-.998 1.233-.696l6.363 3.692z"/>
            </svg>`;
            addLog("All tasks finished.");
        }

        // Settings Logic
        async function openSettings() {
            const config = await pywebview.api.get_config();
            document.getElementById('cfg_aedt_version').value = config.aedt_version || '';
            document.getElementById('cfg_edb_version').value = config.edb_version || '';
            document.getElementById('settingsModal').style.display = 'flex';
        }

        function closeSettings() {
            document.getElementById('settingsModal').style.display = 'none';
        }

        async function saveSettings() {
            const config = {
                aedt_version: document.getElementById('cfg_aedt_version').value,
                edb_version: document.getElementById('cfg_edb_version').value
            };
            const result = await pywebview.api.save_config(config);
            if (result.status === 'success') {
                closeSettings();
                addLog("Configuration saved.");
            } else {
                alert("Failed to save config: " + result.message);
            }
        }

        async function openStackupEditor() {
            const result = await pywebview.api.open_stackup_editor();
            if (result.status === 'error') {
                alert("Failed to open Stackup Editor: " + result.message);
            }
        }
    </script>
</body>

</html>